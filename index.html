<script>
    let tg = window.Telegram.WebApp;
    let send = document.getElementById("btn");
    tg.expand();

    send.addEventListener("click", async () => {
        console.log("Кнопка нажата");

        let fio = document.getElementById("fullname").value.trim();
        let desc = document.getElementById("desc").value.trim();
        let fileInput = document.getElementById("file");
        let file = fileInput.files[0];

        if (!fio || !desc) {
            console.error("ФИО или описание не заполнены!");
            alert("Пожалуйста, заполните все поля.");
            return;
        }

        let fileBase64 = null;
        if (file) {
            console.log("Файл выбран: ", file.name);
            try {
                // Прочитать файл как Base64
                fileBase64 = await new Promise((resolve, reject) => {
                    let reader = new FileReader();
                    reader.onload = () => {
                        console.log("Файл успешно прочитан.");
                        resolve(reader.result.split(",")[1]); // Убираем префикс Base64
                    };
                    reader.onerror = (error) => {
                        console.error("Ошибка чтения файла: ", error);
                        reject(error);
                    };
                    reader.readAsDataURL(file);
                });
            } catch (error) {
                alert("Ошибка при чтении файла.");
                return;
            }
        } else {
            console.log("Файл не выбран.");
        }

        let data = {
            fio: fio,
            desc: desc,
            file: fileBase64, // Кодированное содержимое файла
            fileName: file ? file.name : null, // Имя файла
        };

        console.log("Отправляемые данные: ", data);

        try {
            tg.sendData(JSON.stringify(data));
            tg.close();
        } catch (error) {
            console.error("Ошибка при отправке данных в Telegram WebApp: ", error);
            alert("Произошла ошибка при отправке данных.");
        }
    });
</script>
